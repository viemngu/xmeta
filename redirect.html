<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Redirecting...</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>
<body>
    <script>
        // Hàm giải mã AES-CBC (sử dụng CryptoJS)
        function decryptAES(encrypted, key) {
            try {
                // Chuyển Base64 URL-safe về Base64 chuẩn
                const base64Encoded = encrypted.replace(/-/g, '+').replace(/_/g, '/');
                // Thêm padding nếu cần
                while (base64Encoded.length % 4 !== 0) {
                    base64Encoded += '=';
                }
                const buffer = Buffer.from(base64Encoded, 'base64');
                
                // Tách IV (16 byte) và encrypted data (còn lại)
                const iv = buffer.subarray(0, 16); // IV 16 byte cho CBC
                const data = buffer.subarray(16);

                // Giải mã AES-CBC với CryptoJS
                const keyHex = CryptoJS.enc.Utf8.parse(key);
                const ivHex = CryptoJS.enc.Hex.parse(iv.toString('hex'));
                const encryptedHex = CryptoJS.enc.Hex.parse(data.toString('hex'));

                const decrypted = CryptoJS.AES.decrypt(
                    { ciphertext: encryptedHex },
                    keyHex,
                    { iv: ivHex, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 }
                );

                return decrypted.toString(CryptoJS.enc.Utf8);
            } catch (e) {
                console.error('Decryption failed:', e);
                return null;
            }
        }

        // Lấy tham số URL từ query string
        const urlParams = new URLSearchParams(window.location.search);
        const encryptedUrl = urlParams.get('url');

        // Khóa bí mật (phải khớp với khóa dùng để mã hóa)
        const secretKey = 'MySecretKey2025!@#$'; // Sử dụng chuỗi gốc bạn dùng để tạo khóa SHA-256

        // Giải mã và chuyển hướng
        if (encryptedUrl) {
            const finalUrl = decryptAES(encryptedUrl, secretKey);
            if (finalUrl) {
                window.location.href = finalUrl;
            } else {
                document.body.innerText = 'Invalid or corrupted URL';
            }
        } else {
            document.body.innerText = 'No URL parameter provided';
        }
    </script>
</body>
</html>
